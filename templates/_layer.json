{% set url = entry.polygons.one.getUrl %}
{% set items = craft.csvToJson.convert(url) %}

{% set colours = [] %}

{% for row in entry.colours %}
    {% set colours = colours | merge([row.colour]) %}
{% endfor %}



{% if (items) %}
{
    "type": "FeatureCollection",
    "features": [


        
{% for item in items %}
{
    "type": "Feature",
    "properties": {
        "name": "{{ item['Ward Name'] is defined ? item['Ward Name'] : item['Name'] }}",
        "description": "{% include '_incs/_description' %}",
        "cyp": "{% include '_incs/_cyp' %}",
        "artsaward": "{% include '_incs/_artsaward' %}",
        "education": "{% include '_incs/_education' %}",
        "artsmark": "{% include '_incs/_artsmark' %}",
        "resources": "{% include '_incs/_resources' %}",
        "colour": "{{ entry.nodeUsedForColourRanking | length ? colours[attribute(item,entry.nodeUsedForColourRanking) - 1] }}"
    },
    "geometry": {
        "type": "Polygon",
        "coordinates": [
            {% if '<Polygon>' in item.geometry %}
            {{ item.geometry
                
                | replace({'<MultiGeometry>': ''})
                | replace({'</MultiGeometry>': ''})                
                
                | replace({'</Polygon><Polygon>': '],['})
                | replace({'<Polygon>': '['})
                | replace({'</Polygon>': ']'})

                | replace({'<outerBoundaryIs><LinearRing><coordinates>': '['})
                | replace({'</coordinates></LinearRing></outerBoundaryIs>': ''})
                
                | replace({',0.0 ': '],['})
                | replace({',0.0': ']'})

                
                | replace({'<innerBoundaryIs><LinearRing><coordinates>': '],[['})
                | replace({'</coordinates></LinearRing></innerBoundaryIs>': ''})
                    
                | raw

            }}
            {% else %}
                {{ item.geometry | raw }} {{ item.geometry_cont | raw }} 
            {% endif %}
        ]
    }
}{{ not loop.last ? ',' }}
{% endfor %}

{##########
{% for item in items %}
{
    "type": "Feature",
    "properties": {
        "name": "{{ item['Name'] }}",
        "description": "{% include '_incs/_description' %}",
        "cyp": "{% include '_incs/_cyp' %}",
        "artsaward": "{% include '_incs/_artsaward' %}",
        "education": "{% include '_incs/_education' %}",
        "artsmark": "{% include '_incs/_artsmark' %}",
        "resources": "{% include '_incs/_resources' %}",
        "colour": "{{ entry.nodeUsedForColourRanking | length ? colours[attribute(item,entry.nodeUsedForColourRanking) - 1] }}"
    },
    "geometry": {
        "type": "Polygon",
        "coordinates": [
        ]
    }
}{{ not loop.last ? ',' }}
{% endfor %}
########}


  ]
}
{% endif %}


